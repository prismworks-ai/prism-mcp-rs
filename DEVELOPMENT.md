# Development Guide

This guide covers the development workflow, build system, and contribution process for the Prism MCP SDK.

## Quick start

```bash
# Clone repository
git clone https://github.com/prismworks-ai/prism-mcp-rs
cd prism-mcp-rs

# Install development tools
make install-tools

# Set up development environment
make dev-setup

# Run quick validation
make quick
```

## Build system overview

The project uses multiple complementary build tools:

### Makefile (Primary interface)

The Makefile provides convenient targets for common development tasks. It serves as the primary interface for developers, wrapping more complex commands in simple, memorable targets.

**Key targets:**

| Target | Purpose | When to use |
|--------|---------|-------------|
| `make quick` | Format, lint, basic tests | Before every commit |
| `make check` | Standard CI checks | Before pushing |
| `make full` | Complete CI pipeline | Before releases |
| `make docs-open` | Generate and view docs | When writing documentation |
| `make coverage` | Generate coverage report | To check test coverage |

**Daily workflow:**

```bash
# Before committing
make commit-ready    # Alias for 'make quick'

# Before pushing
make push-ready      # Alias for 'make check'

# Fix issues
make fmt-fix         # Auto-format code
make clippy-fix      # Auto-fix linting issues
```

### build.rs (Cargo build script)

The `build.rs` file is minimal by design. It only handles essential build-time tasks:

- Sets environment variables for version information
- Configures rebuild triggers for important files
- Does NOT generate documentation (handled by docs.rs automatically)

This follows Rust best practices for library crates where documentation is generated by the documentation service.

### Local CI scripts

Located in `scripts/ci/`, these scripts mirror the GitHub Actions pipeline:

| Script | Purpose | Usage |
|--------|---------|-------|
| `local-ci.sh` | Full CI simulation | `./scripts/ci/local-ci.sh` |
| `ci-check.sh` | Quick CI validation | `./scripts/ci/ci-check.sh` |
| `pre-push` | Git hook script | Installed via `make setup-hooks` |

**Script options:**

```bash
# Quick validation
./scripts/ci/local-ci.sh --quick

# Full pipeline with all combinations
./scripts/ci/local-ci.sh --full

# Generate coverage
./scripts/ci/local-ci.sh --coverage

# Skip certain checks
./scripts/ci/local-ci.sh --skip-security --skip-examples
```

## Documentation structure

The project documentation is organized into several categories:

### Source documentation

- **Location:** Inline in `.rs` files
- **Format:** Rust doc comments (`///` and `//!`)
- **Generation:** `cargo doc`
- **Viewing:** `make docs-open`

### User guides

| Document | Purpose | Location |
|----------|---------|----------|
| `README.md` | Project overview and quick start | Root |
| `CONTRIBUTING.md` | Contribution guidelines | Root |
| `DEVELOPMENT.md` | This file - development workflow | Root |
| `docs/PLUGIN_GUIDE.md` | Plugin development guide | docs/ |
| `docs/PLUGIN_TYPES.md` | Plugin type reference | docs/ |
| `docs/API.md` | API documentation | docs/ (auto-generated) |

### Scripts documentation

- **Location:** `scripts/README.md`
- **Purpose:** Documents all automation scripts
- **Categories:** CI, docs, dev, utils

## Testing strategy

### Test categories

1. **Unit tests** - Test individual components
   ```bash
   cargo test --lib
   ```

2. **Integration tests** - Test component interactions
   ```bash
   cargo test --test integration
   ```

3. **Feature tests** - Test feature combinations
   ```bash
   make test-features
   ```

4. **Example validation** - Ensure examples compile
   ```bash
   make examples
   ```

### Coverage requirements

- Aim for >80% code coverage
- Generate reports with `make coverage`
- View HTML report: `open .local/reports/index.html`

## Contributing workflow

### Setting up for contributions

1. **Fork and clone**
   ```bash
   git clone https://github.com/YOUR_USERNAME/prism-mcp-rs
   cd prism-mcp-rs
   ```

2. **Install development tools**
   ```bash
   make install-tools
   ```

3. **Set up Git hooks**
   ```bash
   make setup-hooks
   ```

### Making changes

1. **Create feature branch**
   ```bash
   git checkout -b feature/your-feature
   ```

2. **Make changes and test**
   ```bash
   # Make your changes
   vim src/...
   
   # Run quick checks
   make quick
   
   # Run full tests
   make test-all
   ```

3. **Commit with conventional commits**
   ```bash
   git commit -m "feat: add new feature"
   git commit -m "fix: resolve issue"
   git commit -m "docs: update documentation"
   ```

4. **Push and create PR**
   ```bash
   git push origin feature/your-feature
   # Create PR on GitHub
   ```

### Pre-push checklist

- [ ] Code formatted: `make fmt`
- [ ] Linting passes: `make clippy`
- [ ] Tests pass: `make test-all`
- [ ] Examples compile: `make examples`
- [ ] Documentation builds: `make docs`
- [ ] No security issues: `make security`

## CI/CD pipeline

### GitHub Actions workflows

| Workflow | Trigger | Purpose |
|----------|---------|----------|
| `ci.yml` | Push, PR | Main CI pipeline |
| `security.yml` | Schedule, push | Security audits |
| `release.yml` | Tag push (v*) | Build, publish to crates.io, create GitHub release |
| `dependencies.yml` | Schedule | Dependency updates |
| `benchmarks.yml` | Push to main | Performance benchmarks |

### Local CI simulation

Run the exact same checks as GitHub Actions:

```bash
# Standard CI
make ci-local

# Quick CI
make ci-quick

# Full matrix testing
make ci-full
```

### CI/CD reporting features

The CI pipeline now includes automatic report generation:

#### Coverage reports

- **Generated by:** `cargo-llvm-cov`
- **Output:** `reports/coverage-report.md`
- **Contents:**
  - Overall coverage percentage with badge
  - Line, function, and branch coverage
  - Module-by-module breakdown
  - Uncovered files list
  - Historical trends (when available)

#### Benchmark reports

- **Generated by:** Custom benchmark suite
- **Output:** `reports/benchmark-report.md`
- **Contents:**
  - Client performance metrics (serialization, transport)
  - Server performance metrics (request handling, routing)
  - Plugin performance metrics (tool execution, lifecycle)
  - System information for context
  - Performance comparisons with baselines

#### Viewing reports

**On GitHub:**
- Reports appear in `reports/` folder after main branch pushes
- Download as artifacts from any PR's Actions tab

**Locally:**
```bash
# Generate reports
make reports           # Generate both coverage and benchmarks
make coverage         # Coverage only
make bench           # Benchmarks only

# Or using CI scripts directly
./scripts/ci/local-ci-enhanced.sh --reports
```

### Token requirements

#### For contributors

**No setup required!** All these features work automatically:
- ✅ Running tests
- ✅ Generating coverage reports
- ✅ Running benchmarks
- ✅ CI validation
- ✅ PR checks

GitHub provides the `GITHUB_TOKEN` automatically for each workflow run.

#### For maintainers

**Publishing requires `CRATES_IO_TOKEN`:**
- Set in repository secrets
- Only needed for releases
- Contact repository owner for access

#### For fork owners

**Your fork gets its own tokens:**
- `GITHUB_TOKEN`: Automatic, works immediately
- `CRATES_IO_TOKEN`: Add your own if you want to publish

## Release process

### Preparing a release

1. **Update version in `Cargo.toml`**
   ```toml
   version = "0.2.0"  # Bump according to semver
   ```

2. **Update `CHANGELOG.md`**
   - Add release date
   - Summarize changes
   - Credit contributors

3. **Run release checks**
   ```bash
   make release-check
   cargo publish --dry-run  # Verify package will build
   ```

4. **Create PR with version bump**
   ```bash
   git checkout -b release/v0.2.0
   git commit -am "chore: bump version to 0.2.0"
   git push origin release/v0.2.0
   # Create and merge PR
   ```

### Triggering the release

**Option 1: Via git tag (recommended)**

1. **Create and push a git tag**
   ```bash
   git checkout main
   git pull origin main
   git tag -a v0.2.0 -m "Release version 0.2.0"
   git push origin v0.2.0
   ```

**Option 2: Via GitHub Actions UI**

1. Go to Actions → Release workflow
2. Click "Run workflow"
3. Enter version number (without 'v' prefix)
4. Click "Run workflow"

2. **GitHub Actions will automatically:**
   - Run full CI pipeline
   - Build release binaries for multiple platforms (Linux, macOS, Windows)
   - Create a draft GitHub release with assets
   - Publish to crates.io (using secrets.CRATES_IO_TOKEN)
   - Generate and deploy documentation to GitHub Pages
   - Note: The release is created as a draft and needs manual publishing

3. **Monitor the release**
   - Check GitHub Actions for release workflow status
   - Verify package appears on crates.io
   - Confirm docs are updated on docs.rs

### Post-release tasks

1. **Announce the release**
   - Post in Discord/Slack channels
   - Update project website if applicable
   - Tweet/social media if appropriate

2. **Start next development cycle**
   ```bash
   git checkout -b chore/post-release
   # Update Cargo.toml with -dev suffix or next version
   # Add new "Unreleased" section to CHANGELOG.md
   ```

### Important security notes

- **Never run `cargo publish` locally** - This is handled exclusively by CI/CD
- **Crates.io token (`CRATES_IO_TOKEN`)** must only exist in GitHub Secrets
- **Only maintainers with repository write access** can push tags
- **Release drafts** require manual review before publishing
- **Version consistency** is enforced - Cargo.toml version must match the tag

## Performance optimization

### Benchmarking

```bash
# Run benchmarks
make bench

# Compare with baseline
cargo bench -- --baseline main
```

### Profiling

```bash
# CPU profiling
cargo build --release
perf record --call-graph=dwarf ./target/release/example
perf report

# Memory profiling
valgrind --tool=massif ./target/release/example
```

## Troubleshooting

### Common issues

**Compilation failures:**
```bash
# Clean and rebuild
make clean
cargo build
```

**Test failures:**
```bash
# Run with verbose output
cargo test -- --nocapture
```

**Documentation issues:**
```bash
# Check for broken links
cargo doc --all-features
# Look for warnings in output
```

**Hook not running:**
```bash
# Reinstall hooks
make setup-hooks
# Check hook permissions
ls -la .git/hooks/pre-push
```

## Tool requirements

### Required tools

- Rust 1.85+ (MSRV)
- Cargo
- Git

### Optional tools (for full development)

Install with `make install-tools`:

- `cargo-audit` - Security auditing
- `cargo-llvm-cov` - Code coverage
- `cargo-tree` - Dependency analysis
- `cargo-license` - License checking
- `rustfmt` - Code formatting
- `clippy` - Linting

## Getting help

- **GitHub Issues:** Use the `question` label for questions
- **Documentation:** Check [CONTRIBUTING.md](CONTRIBUTING.md) for contribution process
- **API Reference:** [docs.rs/prism-mcp-rs](https://docs.rs/prism-mcp-rs)

## License

This project is licensed under the MIT License. See LICENSE file for details.